<!-- Navigateur -->

<html>
    <base href="/" />
    <head>
        <link rel='stylesheet' type='text/CSS' href='/styleIndex.css'>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.2/angular.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.2/angular-route.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
        <script src="/services/authService.js"></script>
        <script src="/services/defiService.js"></script>
        <script src="/services/histoService.js"></script>
        <script src="/services/localStorageService.js"></script>
        <script src="/services/quizzService.js"></script>
        <script src="/services/sessionService.js"></script>
        <script src="/services/socketService.js"></script>
        <script src="/services/userService.js"></script>
        <script src="/controllers/defiController.js"></script>
        <script src="/controllers/histoController.js"></script>
        <script src="/controllers/loginController.js"></script>
        <script src="/controllers/quizzController.js"></script>
        <script src="/controllers/socketController.js"></script>
        <script src="/controllers/userController.js"></script>
        <script src="/app.js"></script>
        <script src="/socket.io/socket.io.js"></script>
    </head>
    <body ng-app="app">
        <!-- Test websocket [NE PAS SUPPRIMER, utilisé pour notifs connexion] -->
        <div ng-controller="socketController">
            <button ng-click="test()" type="button">test websocket</button>
            {{serverMessage}}
        </div>

        <!-- Accueil login -->
        <div class="skipLineWithBSn" ng-controller="loginController">
            <div class="disappear bandeau" id="bandeau">
                {{bandeau()}}
            </div>
            <button class="toRight" ng-click="logOut()">Déconnexion</button>
        </div>

        <!-- Défi -->
        <div class="bandeau disappear skipLineWithBSn" ng-controller="socketController" ng-show="confirmDefi !== undefined">
            {{confirmDefi}}
        </div>

        <!-- Notif défi -->
        <div class="bandeau skipLineWithBSn" ng-controller="socketController" ng-show="notifDefi !== undefined && notifDefi !== false">
            {{notifDefi}}
            <div ng-controller="defiController">
                <button ng-click="$parent.supprDefi(); $parent.$parent.notifDefi = false" ng-controller="quizzController" type="button">Accepter le défi</button>
                <button ng-click="supprDefi(); $parent.notifDefi = false" type="button">Refuser le défi</button>
            </div>
        </div>

        <div ng-controller="userController">
            Nombre de défis en attente: {{allDefis.length}}
            <br>
            <button ng-click="showDefis = !showDefis" type="button">Afficher défis</button>
            <div class="linkInteract" ng-repeat="defi in allDefis" ng-show="showDefis == true">
                <div ng-click="showInteract = !showInteract" style="background-color: lightslategray;">
                    Défi lancé par {{defi.ident_user_defiant}}. Score à battre: {{defi.score_user_defiant}}.
                    <div ng-controller="defiController" ng-show="showInteract == true">
                            <!-- $parent.supprDefi(defi._id);  -->
                        <button ng-click="$parent.$parent.$parent.$parent.question = defi.quizz; $parent.$parent.$parent.$parent.launchQuizz = true; $parent.$parent.$parent.$parent.chrono(); $parent.$parent.$parent.showDefis = false" ng-controller="quizzController" type="button">Accepter le défi</button>
                        <button ng-click="supprDefi(defi._id); hideInteract()" type="button">Refuser le défi</button>
                    </div>
                </div>
                <br>
            </div>
        </div>

        <!-- Profil user -->
        <div class="toLeft profil bLBlue" ng-controller="userController">
            <table class="alignTxt">
                <tr>
                    <td><img class="linkInteract" ng-blur="modAvatar = false" ng-click="modAvatar = true" ng-src="{{user.avatar}}"></img>
                        <div ng-show="modAvatar === true">
                            <input class="inputModifImg" ng-blur="modifProfil(user.id, newAvatar, null, null, null); modAvatar = false" ng-enter="modifProfil(user.id, newAvatar, null, null, null)" ng-model="newAvatar" placeholder="Lien vers nouvelle image..." type="text">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="linkInteract" ng-click="modNickname = true">
                        <div ng-show="modNickname != true">
                            {{user.identifiant}}
                        </div>
                        <div ng-show="modNickname == true">
                            <input class="alignTxt bLBlue noBorder" ng-blur="modifProfil(user.id, null, newIdentifiant, null, null); modNickname = false" ng-enter="modifProfil(user.id, null, newIdentifiant, null, null)" ng-model="newIdentifiant" placeholder="{{user.identifiant}}" size="{{newIdentifiant.length}}"  type="text">
                        </div>     
                    </td>
                </tr>
                <tr>
                    <td class="linkInteract" ng-click="modFirstname = true">
                        <div ng-show="modFirstname != true">
                            {{user.prenom}}
                        </div>
                        <div ng-show="modFirstname == true">
                            <input class="alignTxt bLBlue noBorder" ng-blur="modifProfil(user.id, null, null, newPrenom, null); modFirstname = false" ng-enter="modifProfil(user.id, null, null, newPrenom, null)" ng-model="newPrenom" placeholder="{{user.prenom}}" size="{{newPrenom.length}}" type="text">
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="linkInteract" ng-click="modLastname = true">
                        <div ng-show="modLastname != true">
                            {{user.nom}}
                        </div>
                        <div ng-show="modLastname == true">
                            <input class="alignTxt bLBlue noBorder" ng-blur="modifProfil(user.id, null, null, null, newNom); modLastname = false" ng-enter="modifProfil(user.id, null, null, newNom, null)" ng-model="newNom" placeholder="{{user.nom}}" size="{{newNom.length}}" type="text">
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Liste tous users -->
        <div ng-controller="userController">
            <div class="bLGreen toRight userList xAlign">
                <p>
                    Utilisateurs
                    <br>
                    <input ng-click="loggedOnly = !loggedOnly" ng-init="loggedOnly = false" type="checkbox">Connectés uniquement</select>
                </p>
                <label ng-repeat="user in userList">
                    <div ng-if="user.statut === 1 || (user.statut != 1 && loggedOnly === false)">
                        <a class="underlined linkInteract" ng-click="getUserProfile(user.id); toggleProfilDisplay()">{{user.identifiant}}</a>
                    </div>
                </label>
            </div>
            <div class=" bLGreen profil toRight xAlign" ng-show="showProfil">
                <table class="alignTxt">
                    <tr>
                        <td><img ng-src="{{user.avatar}}"></img></td>
                    </tr>
                    <tr>
                        <td>{{user.identifiant}}</td>
                    </tr>
                    <tr>
                        <td>{{user.prenom}}</td>
                    </tr>
                    <tr>
                        <td>{{user.nom}}</td>
                    </tr>
                    <tr>
                        <td><div class="alignTxt circle toCenter" ng-style="user.statut != 1 && {'background-color' : 'red'}"></div></td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Historique des quizz -->
        <div ng-controller="userController">
            <div ng-controller="histoController">
                <button type="button" ng-click="userHisto(user.id); showHistoUser = !showHistoUser">Historique des quizz</button>
                <label class="bLOrange" ng-controller = "histoController" ng-repeat="hist in histoUser | orderBy:'-date'" ng-show="showHistoUser">
                    Quizz du {{hist.date}}:
                    <br>
                    {{hist.nbreponse}} bonnes réponses
                    <br>
                    {{hist.temps}} secondes
                    <br>
                    {{hist.score}} points
                    <br><br>
                </label>
            </div>
        </div>

        <!-- Top 10 scores quizz -->
        <div ng-controller="histoController">
            <button type="button" ng-click="topTen(); showTopTen = !showTopTen">10 meilleurs</button>
            <label  class= "bFPink" ng-controller="userController" ng-repeat="topUser in top10" ng-show="showTopTen">
                <br>
                {{topUser.identifiant}} : {{topUser.sum}}
            </label>
        </div>

        <!-- Quizz -->
        <div ng-controller="quizzController">
            <button ng-click="prepareQuizz = !prepareQuizz; recapQuizz = false; endQuizz = false;" type="button">Nouveau quizz</button>

            <!-- Paramétrage du quizz -->
            <div class="quizzWindow" ng-show="prepareQuizz == true">
                Choix du thème:
                <select ng-init="selectedTheme = selectedTheme || themes[0].value" ng-model="selectedTheme" ng-options="option.value as option.name for option in themes"></select>
                <br>
                <br>
                Nombre de questions: <select ng-init="selectedQuestionCount = selectedQuestionCount || questionCount[0].value" ng-model="selectedQuestionCount" ng-options="option.value as option.name for option in questionCount" ></select>
                <br>
                <br>
                Difficulté: <select ng-init="selectedDifficulty = selectedDifficulty || difficulte[0].value" ng-model="selectedDifficulty" ng-options="option.value as option.name for option in difficulte"> </select>
                <br>
                <br>
                <button ng-click="obtainQuestions(selectedQuestionCount, selectedTheme, selectedDifficulty); chrono(); launchQuizz = true; prepareQuizz = false;" type="button">Lancer quizz</button>
            </div>
            
            <!-- Exécution du quizz -->
            <div class="bFGreen quizzActWindow" ng-show="launchQuizz == true">
                <div ng-repeat="quest in questions track by $index">
                    <label id="question{{$index}}" ng-style="$index != 0 && {'display':'none'}">
                        {{quest.question}}
                            <label ng-repeat="prop in quest.propositions track by $index">
                                <input type="radio" name="propos" ng-model="$parent.propos" value="{{prop}}"> {{$index + 1}} : {{prop}}
                            </label>
                            <button ng-click="checkQuizzStatus(propos, $index, user.id)" type="submit">Valider réponse</button>
                    </label>
                </div>
            </div>

            <!-- Bilan du quizz -->
            <div ng-show="recapQuizz == true">
                Bilan du quizz:
                <br><br>
                <label ng-repeat="elmt in bilan track by $index">
                    Question {{$index + 1}}: {{elmt.question}}
                    <br>
                    Réponse attendue: {{elmt.expRep}}
                    <br>
                    {{elmt.givRep}}
                    <br>
                    Anecdote: {{elmt.anecdote}}
                    <br>
                </label>
                Score: {{bilan.score}}
                <br>
                <button type="button" ng-click="recapQuizz = false">Fermer fenêtre</button>

                <!-- Défi -->
                <div ng-controller="userController">
                    <button type="button" ng-click="getAllUsers(); displayChallengers = !displayChallengers">Défier utilisateur</button>
                    <label ng-repeat="user in userList">
                        <div ng-if="displayChallengers == true">
                            <a class="underlined linkInteract" ng-click="lancerDefi(user.id, user.identifiant, $parent.questions, $parent.bilan.score); $parent.toggleUserList(); " ng-controller="defiController">{{user.identifiant}}</a>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Chrono -->
            <div class="chronoBox" ng-show="launchQuizz == true">
                {{chrn}}
            </div>
        </div>
    </body>
</html>